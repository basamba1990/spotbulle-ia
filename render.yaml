services:
  # Service principal avec frontend et backend int√©gr√©s
  - type: web
    name: spotbulle-ia
    env: node
    plan: starter
    buildCommand: |
      # Nettoyer les caches pr√©c√©dents
      rm -rf node_modules package-lock.json
      rm -rf backend/node_modules backend/package-lock.json
      rm -rf frontend/node_modules frontend/package-lock.json frontend/.next
      
      # Installer les d√©pendances du backend
      echo "üì¶ Installation des d√©pendances backend..."
      cd backend && npm install --production=false
      
      # Installer les d√©pendances du frontend
      echo "üì¶ Installation des d√©pendances frontend..."
      cd ../frontend && npm install --production=false
      
      # V√©rifier les variables d'environnement n√©cessaires
      echo "üîß Configuration des variables d'environnement..."
      export NEXT_PUBLIC_API_URL="https://spotbulle-ia.onrender.com"
      export NODE_ENV="production"
      
      # Build du frontend Next.js avec gestion d'erreurs
      echo "üèóÔ∏è Build du frontend Next.js..."
      npm run build || (echo "‚ùå Erreur lors du build Next.js" && exit 1)
      
      # V√©rifier que le build a r√©ussi
      if [ ! -d ".next" ]; then
        echo "‚ùå Le r√©pertoire .next n'existe pas apr√®s le build"
        exit 1
      fi
      
      # Copier les fichiers statiques vers le r√©pertoire public
      echo "üìÅ Copie des fichiers statiques..."
      mkdir -p ../public/static
      cp -r .next/static/* ../public/static/ 2>/dev/null || echo "‚ö†Ô∏è Aucun fichier statique √† copier"
      
      # Retourner au r√©pertoire racine
      cd ..
      
      echo "‚úÖ Build termin√© avec succ√®s"
    startCommand: |
      echo "üöÄ D√©marrage du serveur SpotBulle IA..."
      export NODE_ENV=production
      export PORT=10000
      node backend/src/server-with-frontend.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: "7d"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: BUCKET_NAME
        value: "pitch-videos"
      - key: FRONTEND_URL
        value: "https://spotbulle-ia.onrender.com"
      - key: NEXT_PUBLIC_API_URL
        value: "https://spotbulle-ia.onrender.com"
      - key: OPENAI_API_KEY
        sync: false
    # Augmenter les ressources pour le build
    disk: 1024
    # Ajouter des health checks
    healthCheckPath: /health

databases:
  - name: spotbulle-ia-db
    plan: basic-256mb

